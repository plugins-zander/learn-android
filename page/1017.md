# 数据库

## SQLlite数据库

Android系统集成了一个轻量级的数据库：SQLite，该数据库只是一个嵌入式的数据库引擎，专门适用于资源有限的设备上适量数据的存取。SQLite允许开发者使用SQL语句操作数据库中的数据，但是它并不需要安装，SQLite数据库只是一个文件。

### SQLiteDatabase简介

SQLiteDatabase代表一个数据库（其实底层是一个数据库文件），当应用程序获取指定数据库的SQLiteDatabase对象后，就可以通过SQLiteDatabase对象管理和操作数据库。SQLiteDatabase提供了几个静态方法打开一个文件对应的数据库，如表所示。

![image](https://img1.zlogs.net/20/20200614011407.png)

获取SQLiteDatabase对象后就可调用SQLiteDatabase的如下方法来操作数据库，如表所示。

![image](https://img1.zlogs.net/20/20200614011436.png)

上面的insert、update、delete、query等方法完全可以通过执行SQL语句来完成，适用于对SQL语句不熟悉的开发者调用。
需要注意的是，上面的query方法都返回了一个Cursor对象，Cursor提供了如表所示的方法移动查询结果的记录指针。

![image-20200614011514090](/home/zander/.config/Typora/typora-user-images/image-20200614011514090.png)



一旦将记录指针移动到指定行后，就可通过调用Cursor的getXxx()方法获取该行的指定列的数据。







### 创建数据库和表

前面已经讲到，使用SQLiteDatabase的静态方法即可打开或创建数据库，例如如下代码：

`SQLiteDatabase.openOrCreateDataBase("/mnt/db/temp.db3",null);`

上面的代码就用于打开或创建一个SQLite数据库，如果/mnt/db/目录下的temp.db3文件 (该文件就是一个数据库）存在，那么程序就是打开该数据库；如果该文件不存在，则上面的代码将会在该目录下创建temp.db3文件（即对应于数据库)。
上面的代码中没有指定SQLiteDatabase.CursorFactory参数，该参数是一个用于返回 Cursor的工厂，如果指定该参数为null，则意味着使用默认的工厂。

上面的代码返回一个SQLiteDatabase对象，该对象的execSQL可执行任意的SQL语句。通过如下代码在程序中创建数据表： 

![image](https://img1.zlogs.net/20/20200614011831.png)



在程序中执行上面的代码即可在数据库中创建一个数据表。







### 使用SQL语句操作SQLite数据库

SQLiteDatabase的execSQL方法可执行任意SQL语句，包括带占位符的SQL语句。但由于该方法没有返回值，因此一般用于执行DDL(data definition language)语句或DML(data manipulation language)语句；如果需要执行査询语句，则可调用SQLiteDatabase的rawQuery(String sql, String[] selectionArgs)方法。



### 使用特定方法操作SQLite数据库

考虑到可能有开发者对SQL语法不熟悉，SQLiteDatabase提供了insert、update、delete以及query语句来操作数据库。
1.使用insert方法插入记录
SQLiteDatabase中的insert方法包括3个参数，具体方法为insert(String table, String nullColumnHack, ContentValues values)，其中table为插入数据的表名，nullColumnHack是指强行插入null值的数据列的列名，当values参数为null时该参数有效，values代表一行记录的数据。
insert()方法中的第三个参数values代表插入一行记录的数据，该参数类型为ContentValues，ContentValues类似于Map，提供了put(String key, Xxx values)方法用于存入数据，getAsXxx(String key)方法用于取出数据。

具体示例代码片段如下：

![image](https://img1.zlogs.net/20/20200614011946.png)

不管values参数是否包含数据，执行insert()方法总会添加一条记录，如果values为空，则会添加一条除主键之外其他字段值都为null的记录。
另外还需要注意的是insert()方法返回类型为long。

2. 使用update方法更新记录
SQLiteDatabase中的update()方法包含4个参数，具体方法为update(String table, ContentValues values, String whereClause, String[] whereArgs)，其中table为更新数据的表名，values为要更新的数据，whereClause	是指更新数据的条件，whereArgs为whereClause子句传入参数。update()方法返回int型数据，表示修改数据的条数。
修改person_inf表中所有主键大于15的人的姓名和地址，示例代码如下：

![image](https://img1.zlogs.net/20/20200614012052.png)



上面示例代码可更直观的看出，第四个参数whereArgs用于向第三个参数whereClause中传入参数。
3. 使用delete方法删除记录
SQLiteDatabase中的delete()方法包含3个参数，具体方法为delete(String table, String whereClause, String[] whereArgs)，其中table是要删除数据的表名，whereClause是删除数据时的要满足的条件，whereArgs用于为whereClause传入参数。
删除person_inf表中所有姓名以“小”开头的记录，示例代码如下：

![image](https://img1.zlogs.net/20/20200614012112.png)

4. 使用query方法查询记录
SQLiteDatabase中的query()方法包含9个参数，具体方法为query(boolean distinct, String table, String[] columns, String whereClause, String[] selectionArgs, String groupBy, String having, String orderBy, String limit)，参数说明如下。
distinct：指定是否去除重复记录。
table：执行查询数据的表名。
columns：要查询出来的列名，相当于select语句select关键字后面的部分。
whereClause：查询条件子句，相当于select语句中where关键字后面的部分，在条件子句中允许使用占位符“？”。

selectionArgs：用于为whereClause子句中的占位符传入参数值，值在数组中的位置与占位符在语句中的位置必须一致；否则会出现异常。
groupBy：用于控制分组，相当于select语句group by关键字后面的部分。
having：用于对分组进行过滤，相当于select语句having关键字后面的部分。
orderBy：用于对记录进行排序，相当于select语句order by关键字后面的部分。
limit：用于进行分页。

该方法中参数较多，大家使用时如果不清楚各个参数的意义，可根据API查询。下面通过示例代码片段展示query()方法的使用，查询person_inf表中人名以“小”开头的记录。

![image](https://img1.zlogs.net/20/20200614012157.png)

query()方法返回的是Cursor类型对象。







### 事务

事务是并发控制的基本单元，SQLiteDatabase中包含如下两个方法来控制事务。
beginTransaction()：开始事务。
endTransaction()：结束事务。
SQLiteDatabase还提供了如下方法判断当前上下文是否处于事务环境中：
inTransaction()：如果当前上下文处于事务环境中则返回true，否则返回false。
当程序执行endTransaction()方法后有两种选择，一种是提交事务，另一种是回滚事务。选择哪一种取决于SQLiteDatabase是否调用了setTransactionSuccessful()方法设置事务标志，如果设置了该方法则提交事务，否则回滚事务。

示例代码如下：

![image](https://img1.zlogs.net/20/20200614012243.png)







### SQLiteOpenHelper类

SQLiteOpenHelper是Android提供的一个管理数据库的工具类，可用于管理数据库的创建和版本更新。
前面介绍了使用SQLiteDatabase中的方法打开数据库，但是在实际开发中最常用的是SQLiteOpenHelper，通过继承SQLiteOpenHelper开发子类，并通过子类的getReadableDatabase()、getWritableDatabase()方法打开数据库。
SQLiteOpenHelper常用方法如表所示。

![image](https://img1.zlogs.net/20/20200614012313.png)

MySQLiteHelper工具类的作用主要是管理数据库的初始化，并允许应用程序通过该工具类获取SQLiteOpenHelper对象。













